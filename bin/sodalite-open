#!/bin/bash
# wrapper around xdg-open.
# Execute xdg-open in background if the launching application is a graphical (i.e., non-terminal) app.
# In case it's a terminal app, launches xdg-open in foreground.
# If launched headless, will always fallback to a text editor

function set_fallback_editor {
    editor=${VISUAL:-$EDITOR}
    if [ ! $editor ]; then
        if type vim; then
            editor=vim
        elif type nano; then
            editor=nano
        else
            echo "Could not find a suitable editor"; exit 1
        fi
    fi
}

# $1: desktop entry name, e.g. 'vim.desktop'
function is_terminal_app {
    desktop_entry=$1
    for location in $locations; do
        entry=$location/$desktop_entry
        [ -f $entry ] && break
    done

    [ -f $entry ] || echo 1

    is_terminal=$(cat "$entry" | grep ^Terminal= | cut -d"=" -f2)
    if [ "$is_terminal" = 'true' ]; then
        echo 0
    else
        echo 1
    fi
}

[ $1 ] || { echo Which file?; exit 1; }

target_file=$1

# if running headless just launch editor
if [ ! $DISPLAY ]; then
    set_fallback_editor
    $editor $target_file
    exit
fi

locations='~/.local/share/applications /usr/share/applications /usr/local/share/applications'
filetype=$(xdg-mime query filetype $target_file)
desktop_entry=$(xdg-mime query default $filetype)

[ "$desktop_entry" ] && [ $(is_terminal_app "$desktop_entry") -eq 0 ] || background="true"

if [ "$background" ]; then
    nohup xdg-open $target_file >/dev/null 2>&1 &
else
    xdg-open $target_file
fi

